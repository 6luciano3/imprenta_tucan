{% extends 'base.html' %}
{% block title %}Crear Proveedor{% endblock %}

{% block content %}
<div class="px-4 md:px-10 lg:px-20 xl:px-40 py-5">
  <div class="max-w-4xl mx-auto">

    <!-- Mensajes del sistema -->
    {% if messages %}
      <div class="mb-6">
        {% for message in messages %}
          <div class="px-4 py-3 rounded-lg shadow text-white
                      {% if message.tags == 'success' %}bg-green-600
                      {% elif message.tags == 'error' %}bg-red-600
                      {% elif message.tags == 'warning' %}bg-yellow-500
                      {% else %}bg-gray-600{% endif %}">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <div class="flex justify-between items-center mb-6">
      <h1 class="text-4xl font-black text-[#111418] dark:text-white">Crear Nuevo Proveedor</h1>
      <a href="{% url 'lista_proveedores' %}" 
         class="flex items-center gap-2 bg-gray-500 text-white px-4 py-2 rounded-lg shadow hover:bg-gray-600">
        <span class="material-symbols-outlined">arrow_back</span>
        Volver
      </a>
    </div>

    <!-- Formulario -->
    <div class="bg-white shadow rounded-xl p-6">
      <form method="POST" class="space-y-6">
        {% csrf_token %}
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Nombre -->
          <div>
            <label for="nombre" class="block text-sm font-medium text-gray-700 mb-2">
              Nombre *
            </label>
            <input type="text" 
                   id="nombre" 
                   name="nombre" 
                   required
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          </div>

          <!-- CUIT -->
          <div>
            <label for="cuit" class="block text-sm font-medium text-gray-700 mb-2">
              CUIT
            </label>
            <input type="text" 
                   id="cuit" 
                   name="cuit" 
                   placeholder="20-12345678-9"
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          </div>

          <!-- Email -->
          <div>
            <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
              Email *
            </label>
            <input type="email" 
                   id="email" 
                   name="email" 
                   required
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          </div>

          <!-- Teléfono -->
          <div>
            <label for="telefono" class="block text-sm font-medium text-gray-700 mb-2">
              Teléfono *
            </label>
            <input type="tel" 
                   id="telefono" 
                   name="telefono" 
                   required
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          </div>

          <!-- Rubro (Catálogo + texto) -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Rubro
            </label>
            <!-- Selección desde catálogo -->
            <select id="rubro_lookup" name="rubro_lookup" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              <option value="">-- Seleccione un rubro del catálogo --</option>
              {% for r in rubros %}
                <option value="{{ r.id }}">{{ r.nombre }}</option>
              {% endfor %}
            </select>
            <div class="mt-2 flex flex-wrap gap-2 items-center">
              <a href="{% url 'lista_rubros' %}"
                 class="inline-flex items-center gap-2 text-xs px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 font-semibold shadow transition"
                 style="text-decoration:none;"
                 title="Gestionar rubros">
                <span class="material-symbols-outlined text-base">category</span>
                Gestionar rubros
              </a>
            </div>
            <!-- Campo textual opcional -->
            <label for="rubro" class="block text-xs text-gray-500 mt-4 mb-1">o ingrese un rubro manualmente</label>
            <input type="text" 
                   id="rubro" 
                   name="rubro" 
                   placeholder="Ej: Papelería, Tintas, Maquinarias"
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          </div>
        </div>

        <!-- Dirección -->
        <div>
          <label for="direccion" class="block text-sm font-medium text-gray-700 mb-2">
            Dirección
          </label>
          <textarea id="direccion" 
                    name="direccion" 
                    rows="3"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
        </div>

        <!-- Botones -->
        <div class="flex justify-end gap-4 pt-6 border-t">
          <a href="{% url 'lista_proveedores' %}" 
             class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
            Cancelar
          </a>
          <button type="submit" 
                  class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center gap-2">
            <span class="material-symbols-outlined">save</span>
            Guardar Proveedor
          </button>
        </div>
      </form>
    </div>

    <!-- Información adicional -->
    <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
      <div class="flex items-start gap-3">
        <span class="material-symbols-outlined text-blue-600 mt-1">info</span>
        <div>
          <h3 class="font-medium text-blue-900">Información</h3>
          <p class="text-sm text-blue-700 mt-1">
            Los campos marcados con (*) son obligatorios. El CUIT y rubro son opcionales pero recomendados para una mejor gestión.
          </p>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
  // Modal Rubros similar al de ciudades
  (function(){
    if(document.getElementById('rubrosModal')) return;
    const wrapper = document.createElement('div');
    wrapper.innerHTML = `
      <div id="rubrosModal" class="hidden fixed inset-0 z-50" style="display:none; z-index:9999;">
        <div id="rubrosModalBackdrop" class="absolute inset-0 bg-black bg-opacity-50"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
          <div class="bg-white w-full max-w-5xl h-[80vh] rounded-xl shadow-2xl overflow-hidden flex flex-col">
            <div class="flex items-center justify-between px-4 py-2 border-b">
              <div class="flex items-center gap-2">
                <span class="material-symbols-outlined">category</span>
                <!-- Título Gestionar Rubros eliminado -->
              </div>
              <div class="flex items-center gap-2">
                <button id="rubrosModalRefresh" class="px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300" title="Recargar contenido">Recargar</button>
                <button id="rubrosModalClose" class="px-3 py-1 bg-gray-700 text-white rounded hover:bg-gray-800">Cerrar</button>
              </div>
            </div>
            <div class="flex-1">
              <iframe id="rubrosModalFrame" src="about:blank" class="w-full h-full"></iframe>
            </div>
          </div>
        </div>
      </div>`;
    document.body.appendChild(wrapper.firstElementChild);

    const modal = document.getElementById('rubrosModal');
    const backdrop = document.getElementById('rubrosModalBackdrop');
    const frame = document.getElementById('rubrosModalFrame');
    const btnClose = document.getElementById('rubrosModalClose');
    const btnRefresh = document.getElementById('rubrosModalRefresh');

    function withParams(url){
      try {
        const u = new URL(url, window.location.origin);
        if(!u.searchParams.has('popup')) u.searchParams.set('popup','1');
        if(!u.searchParams.has('next')) u.searchParams.set('next', window.location.pathname);
        return u.toString();
      } catch(e){
        let sep = url.includes('?') ? '&' : '?';
        return url + sep + 'popup=1&next=' + encodeURIComponent(window.location.pathname);
      }
    }
    function openModal(url){
      frame.src = withParams(url);
      modal.classList.remove('hidden');
      modal.style.display = 'block';
    }
    function closeModal(){
      modal.classList.add('hidden');
      modal.style.display = 'none';
      frame.src = 'about:blank';
      window.location.reload();
    }
    function refreshContent(){ if(frame && frame.contentWindow){ frame.contentWindow.location.reload(); } }

    window.openRubros = function(anchor){
      try { openModal(anchor.getAttribute('data-base-url')); return false; } catch(e){ return true; }
    };

    // Enlazar clicks de forma robusta por clase, por si falla el onclick inline
    document.addEventListener('click', function(e){
      const a = e.target.closest('a.gestionar-rubros-link');
      if(!a) return;
      e.preventDefault();
      try { openModal(a.getAttribute('data-base-url')); } catch(err){ window.location.href = a.href; }
    });

    backdrop.addEventListener('click', closeModal);
    btnClose.addEventListener('click', closeModal);
    btnRefresh.addEventListener('click', refreshContent);
    document.addEventListener('keydown', (e)=>{ if(!modal.classList.contains('hidden') && e.key === 'Escape') closeModal(); });
  })();
</script>
{% endblock %}
