{% extends 'base.html' %}
{% block title %}Detalle del Pedido{% endblock %}

{% block content %}
<div class="px-4 md:px-10 lg:px-20 xl:px-40 py-5">
  <div class="max-w-3xl mx-auto">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-black text-[#111418] dark:text-white">Detalle del Pedido</h1>
      <a href="{% url 'dashboard' %}" class="flex items-center gap-2 bg-gray-500 text-white px-4 py-2 rounded-lg shadow hover:bg-gray-600">
        <span class="material-symbols-outlined">arrow_back</span>
        Volver
      </a>
    </div>
    <div class="bg-white rounded-xl shadow p-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-700">
        <div>
          <p class="font-semibold">ID del Pedido:</p>
          <p class="mb-4">{{ pedido.id }}</p>
        </div>
        <div>
          <p class="font-semibold">Cliente:</p>
          <p class="mb-4">{{ pedido.cliente }}</p>
        </div>
        <div>
          <p class="font-semibold">Producto:</p>
          <p class="mb-4">{{ pedido.producto.nombreProducto }}</p>
        </div>
        <div>
          <p class="font-semibold">Fecha de Pedido:</p>
          <p class="mb-4">{{ pedido.fecha_pedido|date:"d/m/Y" }}</p>
        </div>
        <div>
          <p class="font-semibold">Fecha de Entrega:</p>
          <p class="mb-4">{{ pedido.fecha_entrega|date:"d/m/Y" }}</p>
        </div>
        <div>
          <p class="font-semibold">Cantidad:</p>
          <p class="mb-4">{{ pedido.cantidad }}</p>
        </div>
        <div>
          <p class="font-semibold">Especificaciones:</p>
          <p class="mb-4">{{ pedido.especificaciones|default:"-" }}</p>
        </div>
        <div>
          <p class="font-semibold">Estado:</p>
          <p class="mb-4">{{ pedido.estado.nombre }}</p>
        </div>
        <div>
          <p class="font-semibold">Monto Total:</p>
          <p class="mb-4">${{ pedido.monto_total }}</p>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-xl shadow p-6 mt-6">
      <h2 class="text-xl font-bold mb-4">Insumos requeridos</h2>
      {% if insumos_requeridos and insumos_requeridos|length > 0 %}
      <div class="overflow-x-auto">
        <table class="min-w-full">
          <thead>
            <tr class="text-left border-b">
              <th class="py-2 px-2">Código</th>
              <th class="py-2 px-2">Nombre</th>
              <th class="py-2 px-2 text-right">Requerido</th>
              <th class="py-2 px-2 text-right">Stock</th>
              <th class="py-2 px-2 text-right">Faltan</th>
            </tr>
          </thead>
          <tbody>
            {% for it in insumos_requeridos %}
            <tr class="border-b">
              <td class="py-2 px-2">{{ it.codigo }}</td>
              <td class="py-2 px-2">{{ it.nombre }}</td>
              <td class="py-2 px-2 text-right">{{ it.requerido|floatformat:2 }}</td>
              <td class="py-2 px-2 text-right">{{ it.stock|floatformat:2 }}</td>
              <td class="py-2 px-2 text-right {% if it.faltan > 0 %}text-red-600 font-semibold{% endif %}">{{ it.faltan|floatformat:2 }}</td>
            </tr>
            {% if it.faltan > 0 %}
            <tr>
              <td colspan="5">
                <form class="feedback-form bg-yellow-50 border border-yellow-200 rounded p-4 my-4" data-insumo-id="{{ it.id }}">
                  <div class="font-semibold mb-2">Feedback sobre recomendación de proveedor para <span class="text-blue-900">{{ it.nombre }}</span>:</div>
                  <div class="flex flex-col md:flex-row gap-2 mb-2">
                    <label>Decisión:
                      <select name="decision" class="border rounded px-2 py-1">
                        <option value="aceptar">Aceptar</option>
                        <option value="modificar">Modificar</option>
                        <option value="rechazar">Rechazar</option>
                      </select>
                    </label>
                    <label>Proveedor recomendado:
                      <input type="number" name="proveedor_recomendado_id" class="border rounded px-2 py-1" placeholder="ID proveedor recomendado" required readonly>
                    </label>
                    <label>Proveedor elegido:
                      <input type="number" name="proveedor_final_id" class="border rounded px-2 py-1" placeholder="ID proveedor elegido" required>
                    </label>
                  </div>
                  <label class="block mb-2">Comentario:
                    <input type="text" name="comentario" class="border rounded px-2 py-1 w-full" placeholder="Motivo o comentario opcional">
                  </label>
                  <div class="flex flex-wrap gap-2 mb-2">
                    <label>Peso precio: <input type="number" step="0.01" name="feedback_precio" class="border rounded px-2 py-1 w-16" value="0"></label>
                    <label>Peso cumplimiento: <input type="number" step="0.01" name="feedback_cumplimiento" class="border rounded px-2 py-1 w-16" value="0"></label>
                    <label>Peso incidencias: <input type="number" step="0.01" name="feedback_incidencias" class="border rounded px-2 py-1 w-16" value="0"></label>
                    <label>Peso disponibilidad: <input type="number" step="0.01" name="feedback_disponibilidad" class="border rounded px-2 py-1 w-16" value="0"></label>
                  </div>
                  <input type="hidden" name="pedido_id" value="{{ pedido.id }}">
                  <input type="hidden" name="insumo_id" value="{{ it.id }}">
                  <button type="submit" class="bg-yellow-400 hover:bg-yellow-500 text-gray-900 font-semibold px-4 py-2 rounded shadow opacity-50 cursor-not-allowed" disabled>Enviar feedback</button>
                  <span class="feedback-msg ml-4 text-green-700 font-semibold"></span>
                </form>
              </td>
            </tr>
            {% endif %}
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <p class="text-gray-600">No hay receta definida para este producto o no requiere insumos.</p>
      {% endif %}
    </div>
  </div>
</div>
</script>
<script>
// Enviar feedback de recomendación de proveedor y autocompletar proveedor recomendado
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.feedback-form').forEach(function(form) {
    // Autocompletar proveedor recomendado
    const insumoId = form.querySelector('input[name="insumo_id"]').value;
    const recomendadoInput = form.querySelector('input[name="proveedor_recomendado_id"]');
    const recomendadoLabel = document.createElement('span');
    recomendadoLabel.className = 'ml-2 text-sm text-gray-600 proveedor-recomendado-label';
    recomendadoInput.parentNode.appendChild(recomendadoLabel);
    // Preparar elementos para autocompletar proveedor final y decisión
    const finalInput = form.querySelector('input[name="proveedor_final_id"]');
    const finalLabel = document.createElement('span');
    finalLabel.className = 'ml-2 text-sm text-gray-600 proveedor-final-label';
    finalInput.parentNode.appendChild(finalLabel);
    const decisionSelect = form.querySelector('select[name="decision"]');
    const comentarioInput = form.querySelector('input[name="comentario"]');

    // Mostrar estado de carga mientras se consulta la recomendación
    recomendadoLabel.textContent = 'Buscando recomendación...';
    fetch('/api/recomendar-proveedor/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ insumo_id: insumoId })
    })
    .then(r => r.json())
    .then(data => {
      if (data.proveedor_id) {
        recomendadoInput.value = data.proveedor_id;
        recomendadoLabel.textContent = `(${data.proveedor_nombre})`;
        // Autocompletar proveedor elegido con el recomendado
        finalInput.value = data.proveedor_id;
        finalLabel.textContent = `(${data.proveedor_nombre})`;
        // Seleccionar decisión por defecto
        if (decisionSelect) {
          decisionSelect.value = 'aceptar';
        }
        // Prefijar comentario informativo si está vacío
        if (comentarioInput && !comentarioInput.value) {
          comentarioInput.value = `Autocompletado: proveedor recomendado ${data.proveedor_nombre}`;
        }
        // Autocompletar pesos de criterios desde API
        fetch('/api/criterios-pesos/', { method: 'GET' })
          .then(r => r.json())
          .then(weights => {
            const precio = form.querySelector('input[name="feedback_precio"]');
            const cumplimiento = form.querySelector('input[name="feedback_cumplimiento"]');
            const incidencias = form.querySelector('input[name="feedback_incidencias"]');
            const disponibilidad = form.querySelector('input[name="feedback_disponibilidad"]');
            if (precio) precio.value = weights.precio ?? 0;
            if (cumplimiento) cumplimiento.value = weights.cumplimiento ?? 0;
            if (incidencias) incidencias.value = weights.incidencias ?? 0;
            if (disponibilidad) disponibilidad.value = weights.disponibilidad ?? 0;
            // Habilitar botón de envío cuando todos los campos fueron completados
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) {
              submitBtn.disabled = false;
              submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
          })
          .catch(() => { /* dejar valores por defecto */ });
      } else {
        // Fallback: tomar el primer proveedor con score disponible
        fetch('/api/score-proveedores/', { method: 'GET' })
          .then(r => r.json())
          .then(list => {
            if (Array.isArray(list) && list.length > 0) {
              const p = list[0];
              if (p && p.proveedor) {
                recomendadoInput.value = p.proveedor;
                recomendadoLabel.textContent = `(${p.proveedor_nombre || 'Proveedor'})`;
                finalInput.value = p.proveedor;
                finalLabel.textContent = `(${p.proveedor_nombre || 'Proveedor'})`;
                if (decisionSelect) {
                  decisionSelect.value = 'aceptar';
                }
                if (comentarioInput && !comentarioInput.value) {
                  comentarioInput.value = `Autocompletado (fallback): ${p.proveedor_nombre || 'Proveedor'}`;
                }
                // Cargar pesos y habilitar botón
                fetch('/api/criterios-pesos/', { method: 'GET' })
                  .then(r2 => r2.json())
                  .then(weights => {
                    const precio = form.querySelector('input[name="feedback_precio"]');
                    const cumplimiento = form.querySelector('input[name="feedback_cumplimiento"]');
                    const incidencias = form.querySelector('input[name="feedback_incidencias"]');
                    const disponibilidad = form.querySelector('input[name="feedback_disponibilidad"]');
                    if (precio) precio.value = weights.precio ?? 0;
                    if (cumplimiento) cumplimiento.value = weights.cumplimiento ?? 0;
                    if (incidencias) incidencias.value = weights.incidencias ?? 0;
                    if (disponibilidad) disponibilidad.value = weights.disponibilidad ?? 0;
                    const submitBtn = form.querySelector('button[type="submit"]');
                    if (submitBtn) {
                      submitBtn.disabled = false;
                      submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    }
                  })
                  .catch(() => { /* ignore */ });
              } else {
                recomendadoLabel.textContent = 'No hay proveedores disponibles';
                finalLabel.textContent = '';
              }
            } else {
              recomendadoLabel.textContent = 'No hay proveedores disponibles';
              finalLabel.textContent = '';
            }
          })
          .catch(() => {
            recomendadoLabel.textContent = 'Error al obtener recomendación';
            finalLabel.textContent = '';
          });
      }
    })
    .catch(() => {
      recomendadoLabel.textContent = 'Error al obtener recomendación';
      finalLabel.textContent = '';
    });

    // Enviar feedback
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(form));
      fetch('/api/feedback-recomendacion/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })
      .then(r => r.json())
      .then(resp => {
        form.querySelector('.feedback-msg').textContent = resp.mensaje || '¡Feedback enviado!';
      })
      .catch(() => {
        form.querySelector('.feedback-msg').textContent = 'Error al enviar feedback';
      });
    });
  });
});
</script>
{% endblock %}
