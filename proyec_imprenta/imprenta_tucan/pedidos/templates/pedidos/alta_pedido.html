{% extends 'base.html' %}
{% block title %}Alta de Pedido{% endblock %}

{% block extra_head %}
<!-- Bootstrap 5 CDN (solo para esta pantalla) -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<style>
  .table thead th { white-space: nowrap; }
  .linea-total, .unitario { width: 120px; }
  .cantidad-input { max-width: 120px; }
  .remove-line { white-space: nowrap; }
  .subtotal-box { font-size: 1.2rem; font-weight: 600; }
  .tr-hidden { display: none !important; }
  .w-180 { width: 180px; }
  .w-240 { width: 240px; }
  .w-120 { width: 120px; }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
  <!-- Calculadora de consumo de insumos -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h2 class="h5 fw-bold mb-3">üìê Calculadora de consumo de insumos</h2>
      <div class="row g-3 align-items-end">
        <div class="col-md-5">
          <label class="form-label">Producto</label>
          <select id="calc-producto" class="form-select">
            <option value="">Seleccione un producto‚Ä¶</option>
            {% for p in productos_calculadora %}
              <option value="{{ p.idProducto }}" data-um="{{ p.unidadMedida__abreviatura|default:'' }}" data-umnom="{{ p.unidadMedida__nombreUnidad|default:'' }}">{{ p.nombreProducto }}</option>
            {% endfor %}
          </select>
          <div id="calc-um" class="form-text"></div>
        </div>
        <div class="col-md-3">
          <label class="form-label">Cantidad</label>
          <input id="calc-cantidad" type="number" min="1" step="1" value="1" class="form-control" />
        </div>
        <div class="col-md-2 d-grid">
          <button id="calc-btn" type="button" class="btn btn-primary">
            Calcular
          </button>
          <button id="calc-clear" type="button" class="btn btn-outline-secondary mt-2">
            Limpiar
          </button>
          <button id="calc-detail" type="button" class="btn btn-outline-info mt-2">
            Detalle
          </button>
        </div>
        <div class="col-md-2 d-grid">
          <button id="calc-add-line" type="button" class="btn btn-outline-success" disabled>
            + Agregar al pedido
          </button>
          <div class="form-text mt-1">Unitario: $<span id="calc-unitario-monto">0.00</span></div>
        </div>
      </div>
      <div id="calc-alert" class="alert mt-3 d-none" role="alert"></div>
      <div id="calc-resultado" class="mt-3 d-none table-responsive">
        <table class="table table-bordered align-middle">
          <thead class="table-light">
            <tr>
              <th>C√≥digo</th>
              <th>Insumo</th>
              <th>Requerido</th>
              <th>Stock</th>
              <th>Faltan</th>
            </tr>
          </thead>
          <tbody id="calc-tbody"></tbody>
        </table>
      </div>
      <span id="calc-url-template" data-url="{% url 'calcular_consumo_producto' 0 0 %}" class="d-none"></span>
    </div>
  </div>
  <!-- Modal Detalle de Consumo -->
  <div class="modal fade" id="calcDetalleModal" tabindex="-1" aria-labelledby="calcDetalleLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="calcDetalleLabel">Detalle de consumo</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2 text-muted" id="calc-detalle-info"></div>
          <div class="table-responsive">
            <table class="table table-sm table-bordered align-middle">
              <thead class="table-light">
                <tr>
                  <th>C√≥digo</th>
                  <th>Insumo</th>
                  <th class="text-end">Requerido</th>
                  <th class="text-end">Stock</th>
                  <th class="text-end">Faltan</th>
                </tr>
              </thead>
              <tbody id="calc-detalle-tbody"></tbody>
            </table>
          </div>
          <div id="calc-detalle-resumen" class="mt-2 fw-semibold"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 fw-bold mb-0">üìù Registrar nuevo pedido</h1>
    <a href="{% url 'lista_pedidos' %}" class="btn btn-secondary">Volver</a>
  </div>

  <!-- Toast/alert de acci√≥n r√°pida (cliente) -->
  <div id="addToast" class="alert alert-success d-none" role="alert">L√≠nea agregada al pedido.</div>

  <div class="card shadow-sm">
    <div class="card-body">
      <div id="stockAlert" class="alert alert-danger d-none" role="alert"></div>
      <form method="post" novalidate>
        {% csrf_token %}

        <!-- Cabecera -->
        <div class="row g-3 mb-3">
          <div class="col-md-5">
            <label class="form-label">Cliente</label>
            {{ header_form.cliente }}
          </div>
          <div class="col-md-3">
            <label class="form-label">Fecha de Pedido</label>
            <input type="date" class="form-control" value="{{ fecha_pedido_hoy|date:'Y-m-d' }}" disabled>
          </div>
          <div class="col-md-3">
            <label class="form-label">Fecha de Entrega</label>
            {{ header_form.fecha_entrega }}
          </div>
          <div class="col-md-1 d-flex align-items-end">
            <div class="form-check">
              {{ header_form.aplicar_iva }}
              <label class="form-check-label ms-1" for="id_aplicar_iva">IVA 21%</label>
            </div>
          </div>
        </div>

        <!-- L√≠neas -->
        {{ formset.management_form }}
        <div class="table-responsive">
          <table class="table table-bordered align-middle" id="tablaLineas">
            <thead class="table-light">
              <tr>
                <th class="w-240">Producto</th>
                <th class="w-120">Cant.</th>
                <th>Especificaciones</th>
                <th class="w-120 text-end">Unitario</th>
                <th class="w-120 text-end">Importe</th>
                <th class="w-120">Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for form in formset.forms %}
              <tr class="linea" data-index="{{ forloop.counter0 }}">
                <td>{{ form.producto }}</td>
                <td>{{ form.cantidad }}</td>
                <td>{{ form.especificaciones }}</td>
                <td class="text-end"><input type="text" class="form-control text-end unitario" value="0.00" readonly></td>
                <td class="text-end"><input type="text" class="form-control text-end linea-total" value="0.00" readonly></td>
                <td class="remove-line">
                  <button type="button" class="btn btn-outline-danger btn-sm btn-remove">Quitar</button>
                  {% if form.DELETE %}{{ form.DELETE }}{% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="d-flex justify-content-between align-items-center mt-2 gap-2">
          <div class="d-flex gap-2">
            <button type="button" id="btnAdd" class="btn btn-outline-primary">+ Agregar producto</button>
            <button type="button" id="btnAddSame" class="btn btn-outline-secondary d-none">+ Agregar misma l√≠nea</button>
          </div>
          <div>
            <label class="form-label me-2 mb-0">Subtotal</label>
            <input id="subtotal" class="form-control d-inline-block subtotal-box text-end" type="text" value="0.00" readonly style="width: 160px;">
            <label class="form-label ms-3 me-2 mb-0">Monto Total</label>
            <input id="montoTotal" class="form-control d-inline-block subtotal-box text-end" type="text" value="0.00" readonly style="width: 160px;">
          </div>
        </div>

        <div class="d-flex justify-content-end gap-2 mt-4">
          <button type="reset" class="btn btn-outline-secondary" id="btnReset">Limpiar</button>
          <button type="submit" class="btn btn-primary" id="btnSubmit">Registrar Pedido</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Fila plantilla para agregar din√°micamente -->
<template id="filaTemplate">
  <tr class="linea" data-index="__prefix__">
    <td>
      {{ formset.empty_form.producto.as_widget }}
    </td>
    <td>
      {{ formset.empty_form.cantidad.as_widget }}
    </td>
    <td>
      {{ formset.empty_form.especificaciones.as_widget }}
    </td>
    <td class="text-end"><input type="text" class="form-control text-end unitario" value="0.00" readonly></td>
    <td class="text-end"><input type="text" class="form-control text-end linea-total" value="0.00" readonly></td>
    <td class="remove-line">
      <button type="button" class="btn btn-outline-danger btn-sm btn-remove">Quitar</button>
      {% if formset.empty_form.DELETE %}{{ formset.empty_form.DELETE.as_widget }}{% endif %}
    </td>
  </tr>
  </template>

<script>
  (function() {
  const precios = {{ precios|default:'{}'|safe }};
    const tabla = document.getElementById('tablaLineas');
    const tbody = tabla.querySelector('tbody');
    const btnAdd = document.getElementById('btnAdd');
    const subtotalInput = document.getElementById('subtotal');
    const totalInput = document.getElementById('montoTotal');
    const ivaCheckbox = document.querySelector('input[name="aplicar_iva"]');
  const template = document.getElementById('filaTemplate');
  const btnAddSame = document.getElementById('btnAddSame');

    const mgmtTotal = document.querySelector('[name="lineas-TOTAL_FORMS"]');
    const mgmtInitial = document.querySelector('[name="lineas-INITIAL_FORMS"]');
  const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
  const stockAlert = document.getElementById('stockAlert');
  const btnSubmit = document.getElementById('btnSubmit');

    function toNumber(val) {
      const n = parseFloat(val);
      return isFinite(n) ? n : 0;
    }

    function format(n) { return (Math.round(n * 100) / 100).toFixed(2); }

    function recalcRow(tr) {
      const select = tr.querySelector('select');
      const cantidadInput = tr.querySelector('.cantidad-input, input[name$="-cantidad"]');
      const unitarioInput = tr.querySelector('.unitario');
      const totalInput = tr.querySelector('.linea-total');
      const prodId = parseInt(select?.value || '0', 10);
      const precio = precios[prodId] || 0;
      const cantidad = parseInt(cantidadInput?.value || '0', 10) || 0;
      unitarioInput.value = format(precio);
      totalInput.value = format(precio * cantidad);
    }

    function recalcSubtotal() {
      let sum = 0;
      tbody.querySelectorAll('tr.linea:not(.tr-hidden)').forEach(tr => {
        const total = tr.querySelector('.linea-total')?.value || '0';
        sum += toNumber(total);
      });
      subtotalInput.value = format(sum);
      recalcGrandTotal();
    }

    function recalcGrandTotal() {
      const subtotal = toNumber(subtotalInput.value);
      const aplicar = ivaCheckbox?.checked;
      const total = aplicar ? subtotal * 1.21 : subtotal;
      totalInput.value = format(total);
    }

    function bindRowEvents(tr) {
      const select = tr.querySelector('select');
      const cantidadInput = tr.querySelector('.cantidad-input, input[name$="-cantidad"]');
      const btnRemove = tr.querySelector('.btn-remove');
      const delInput = tr.querySelector('input[name$="-DELETE"]');
      select?.addEventListener('change', () => { recalcRow(tr); recalcSubtotal(); scheduleCheckStock(); });
      cantidadInput?.addEventListener('input', () => { recalcRow(tr); recalcSubtotal(); scheduleCheckStock(); });
      btnRemove?.addEventListener('click', () => {
        if (delInput) {
          delInput.checked = true;
        }
        tr.classList.add('tr-hidden');
        recalcSubtotal();
        scheduleCheckStock();
      });
      // Calcular cuando carga
      recalcRow(tr);
    }

    // Enlazar filas existentes
    tbody.querySelectorAll('tr.linea').forEach(bindRowEvents);
    recalcSubtotal();

    btnAdd?.addEventListener('click', () => {
      const idx = parseInt(mgmtTotal.value, 10) || 0;
      const html = template.innerHTML.replaceAll('__prefix__', idx);
      const tempContainer = document.createElement('tbody');
      tempContainer.innerHTML = html.trim();
      const tr = tempContainer.querySelector('tr');
      tbody.appendChild(tr);
      mgmtTotal.value = String(idx + 1);
      bindRowEvents(tr);
      recalcSubtotal();
      scheduleCheckStock();
    });

    // Atajo: agregar una nueva l√≠nea con el mismo producto/cantidad que los par√°metros de la URL
    function getUrlParams() {
      try {
        const url = new URL(window.location.href);
        return {
          producto: parseInt(url.searchParams.get('producto') || '0', 10) || 0,
          cantidad: parseInt(url.searchParams.get('cantidad') || '0', 10) || 0,
        };
      } catch (e) {
        return { producto: 0, cantidad: 0 };
      }
    }

    const prefill = getUrlParams();
    if (prefill.producto && prefill.cantidad > 0) {
      btnAddSame.classList.remove('d-none');
    }

    btnAddSame?.addEventListener('click', () => {
      const idx = parseInt(mgmtTotal.value, 10) || 0;
      const html = template.innerHTML.replaceAll('__prefix__', idx);
      const tempContainer = document.createElement('tbody');
      tempContainer.innerHTML = html.trim();
      const tr = tempContainer.querySelector('tr');
      tbody.appendChild(tr);
      mgmtTotal.value = String(idx + 1);
      bindRowEvents(tr);
      // Setear mismo producto y cantidad
      const select = tr.querySelector('select');
      const cantidadInput = tr.querySelector('.cantidad-input, input[name$="-cantidad"]');
      if (select) {
        select.value = String(prefill.producto);
        select.dispatchEvent(new Event('change'));
      }
      if (cantidadInput) {
        cantidadInput.value = String(prefill.cantidad);
        cantidadInput.dispatchEvent(new Event('input'));
      }
      recalcSubtotal();
      scheduleCheckStock();
    });

    ivaCheckbox?.addEventListener('change', recalcGrandTotal);

    document.getElementById('btnReset')?.addEventListener('click', () => {
      // Reset visible totals
      setTimeout(() => {
        tbody.querySelectorAll('tr.linea').forEach(tr => {
          tr.classList.remove('tr-hidden');
          const delInput = tr.querySelector('input[name$="-DELETE"]');
          if (delInput) delInput.checked = false;
          recalcRow(tr);
        });
        recalcSubtotal();
        if (ivaCheckbox) ivaCheckbox.checked = false;
        recalcGrandTotal();
        clearStockAlert();
      }, 0);
    });

    // --- Validaci√≥n din√°mica de stock (AJAX) ---
    let debounceTimer;
    function scheduleCheckStock() {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(checkStock, 400);
    }

    function clearStockAlert() {
      stockAlert.classList.add('d-none');
      stockAlert.textContent = '';
      btnSubmit.disabled = false;
    }

    async function checkStock() {
      // Construye las l√≠neas visibles y no marcadas como DELETE
      const lineas = [];
      tbody.querySelectorAll('tr.linea').forEach(tr => {
        if (tr.classList.contains('tr-hidden')) return;
        const delInput = tr.querySelector('input[name$="-DELETE"]');
        if (delInput && delInput.checked) return;
        const select = tr.querySelector('select');
        const cantidadInput = tr.querySelector('.cantidad-input, input[name$="-cantidad"]');
        const pid = parseInt(select?.value || '0', 10);
        const cant = parseInt(cantidadInput?.value || '0', 10) || 0;
        if (pid && cant > 0) lineas.push({ producto: pid, cantidad: cant });
      });

      if (lineas.length === 0) { clearStockAlert(); return; }

      try {
        const resp = await fetch('{% url "verificar_stock" %}', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
          body: JSON.stringify({ lineas })
        });
        if (!resp.ok) { throw new Error('Error al verificar stock'); }
        const data = await resp.json();
        if (data.ok) { clearStockAlert(); return; }
        // Mostrar faltantes
        const detalle = (data.faltantes || []).map(f => `${f.codigo} - ${f.nombre}: faltan ${Number(f.faltan).toFixed(2)}`).join(', ');
        stockAlert.textContent = detalle || 'No hay insumos suficientes para las cantidades seleccionadas.';
        stockAlert.classList.remove('d-none');
        btnSubmit.disabled = true;
      } catch (e) {
        // En caso de error en AJAX, no bloquear env√≠o pero mostrar advertencia gen√©rica
        stockAlert.textContent = 'No se pudo verificar el stock en este momento.';
        stockAlert.classList.remove('d-none');
        btnSubmit.disabled = false;
      }
    }

    // Primera verificaci√≥n al cargar
    scheduleCheckStock();
  // Exponer mapa de precios a otros scripts
  window.__precios = precios;

    // Exponer una funci√≥n global para agregar una l√≠nea desde la calculadora
    window.pedidoAddLine = function(pid, c) {
      try {
        const idx = parseInt(mgmtTotal.value, 10) || 0;
        const html = template.innerHTML.replaceAll('__prefix__', idx);
        const tempContainer = document.createElement('tbody');
        tempContainer.innerHTML = html.trim();
        const tr = tempContainer.querySelector('tr');
        tbody.appendChild(tr);
        mgmtTotal.value = String(idx + 1);
        bindRowEvents(tr);
        // Setear producto y cantidad nuevos y recalcular
        const select = tr.querySelector('select');
        const cantidadInput = tr.querySelector('.cantidad-input, input[name$="-cantidad"]');
        if (select) {
          select.value = String(pid);
          select.dispatchEvent(new Event('change'));
        }
        if (cantidadInput) {
          cantidadInput.value = String(c);
          cantidadInput.dispatchEvent(new Event('input'));
        }
        recalcSubtotal();
        scheduleCheckStock();
      } catch (e) {
        console.error('No se pudo agregar la l√≠nea desde la calculadora:', e);
      }
    }
  })();
  </script>
  <script>
    (function() {
      const precios = window.__precios || {};
      const btn = document.getElementById('calc-btn');
      const addBtn = document.getElementById('calc-add-line');
      const sel = document.getElementById('calc-producto');
      const qty = document.getElementById('calc-cantidad');
      const tbody = document.getElementById('calc-tbody');
      const resultBox = document.getElementById('calc-resultado');
      const alertBox = document.getElementById('calc-alert');
      const urlTemplate = document.getElementById('calc-url-template').dataset.url;
      const umLabel = document.getElementById('calc-um');
  const unitEl = document.getElementById('calc-unitario-monto');
  const clearBtn = document.getElementById('calc-clear');
  const detailBtn = document.getElementById('calc-detail');

  // Cache del √∫ltimo c√°lculo para reusar en el Detalle
  let lastCalc = null; // { pid, c, data, prodName }

      function setAlert(ok, text) {
        alertBox.classList.remove('d-none', 'alert-danger', 'alert-success');
        alertBox.classList.add(ok ? 'alert-success' : 'alert-danger');
        alertBox.textContent = text;
      }

      function clearAlert() {
        alertBox.classList.add('d-none');
        alertBox.textContent = '';
      }

      function updateUM() {
        const opt = sel.options[sel.selectedIndex];
        const um = opt?.dataset?.um || '';
        const umnom = opt?.dataset?.umnom || '';
        umLabel.textContent = (um || umnom) ? `Unidad: ${um || umnom}` : '';
      }

      function updateUnitPrice() {
        const pid = parseInt(sel.value || '0', 10);
        const unit = Number(precios[pid] || 0);
        if (unitEl) unitEl.textContent = unit.toFixed(2);
      }

      async function calcular() {
        const pid = sel.value;
        const c = parseInt(qty.value || '0', 10);
        updateUM();
        updateUnitPrice();
        if (!pid || !c || c < 1) {
          setAlert(false, 'Seleccione un producto y una cantidad v√°lida.');
          resultBox.classList.add('d-none');
          tbody.innerHTML = '';
          addBtn.disabled = true;
          lastCalc = null;
          return null;
        }
        try {
          const url = urlTemplate.replace('/0/0/', `/${pid}/${c}/`);
          const resp = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
          const data = await resp.json();
          if (!data.success) throw new Error(data.error || 'Error desconocido');

          tbody.innerHTML = '';
          (data.consumo || []).forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${item.codigo}</td>
              <td>${item.nombre}</td>
              <td>${Number(item.requerido).toLocaleString()}</td>
              <td>${Number(item.stock).toLocaleString()}</td>
              <td class="${item.faltan > 0 ? 'text-danger fw-semibold' : ''}">${Number(item.faltan).toLocaleString()}</td>
            `;
            tbody.appendChild(tr);
          });
          resultBox.classList.toggle('d-none', (data.consumo || []).length === 0);
          setAlert(data.ok, data.ok ? 'Stock suficiente para esta cantidad.' : 'Faltan insumos para esta cantidad.');
          addBtn.disabled = !pid || !c;

          // Guardar cache del √∫ltimo c√°lculo
          const prodName = sel.options[sel.selectedIndex]?.text || 'Producto';
          lastCalc = { pid: parseInt(pid, 10), c, data, prodName };
          return lastCalc;
        } catch (err) {
          setAlert(false, 'No se pudo calcular el consumo: ' + (err?.message || err));
          resultBox.classList.add('d-none');
          tbody.innerHTML = '';
          addBtn.disabled = true;
          lastCalc = null;
          return null;
        }
      }

      btn.addEventListener('click', calcular);
      sel.addEventListener('change', calcular);
      qty.addEventListener('input', () => {
        clearTimeout(window.__calcTimer2);
        window.__calcTimer2 = setTimeout(calcular, 400);
      });
      clearBtn.addEventListener('click', () => {
        // Reset selector y cantidad
        if (sel) sel.value = '';
        if (qty) qty.value = '1';
        // Reset labels
        if (umLabel) umLabel.textContent = '';
        if (unitEl) unitEl.textContent = '0.00';
        // Ocultar resultados y alertas
        resultBox.classList.add('d-none');
        tbody.innerHTML = '';
        clearAlert();
        // Deshabilitar agregar hasta nuevo c√°lculo
        addBtn.disabled = true;
        lastCalc = null;
      });

      function populateDetalleModal(calc) {
        try {
          const info = document.getElementById('calc-detalle-info');
          const body = document.getElementById('calc-detalle-tbody');
          const resumen = document.getElementById('calc-detalle-resumen');
          if (!calc || !calc.data) return;
          const consumo = calc.data.consumo || [];
          info.textContent = `${calc.prodName} ‚Äî Cantidad: ${calc.c}`;
          body.innerHTML = '';
          let totalReq = 0;
          let totalFalt = 0;
          let totalStock = 0;
          if (consumo.length === 0) {
            const tr = document.createElement('tr');
            const adminUrl = `/admin/productos/productoinsumo/?producto__id__exact=${calc.pid}`;
            const detalleUrl = `/productos/detalle/${calc.pid}/`;
            tr.innerHTML = `
              <td colspan="5" class="text-center text-muted">
                No hay insumos para mostrar. Es posible que el producto no tenga receta definida.
                <div class="mt-2">
                  <a class="btn btn-sm btn-outline-primary me-2" href="${adminUrl}" target="_blank">Gestionar receta</a>
                  <a class="btn btn-sm btn-outline-secondary" href="${detalleUrl}" target="_blank">Ver producto</a>
                </div>
              </td>`;
            body.appendChild(tr);
          }
          consumo.forEach(item => {
            const tr = document.createElement('tr');
            const req = Number(item.requerido) || 0;
            const falt = Number(item.faltan) || 0;
            const stk = Number(item.stock) || 0;
            totalReq += req;
            totalFalt += falt;
            totalStock += stk;
            tr.innerHTML = `
              <td>${item.codigo}</td>
              <td>${item.nombre}</td>
              <td class="text-end">${req.toLocaleString()}</td>
              <td class="text-end">${stk.toLocaleString()}</td>
              <td class="text-end ${falt > 0 ? 'text-danger fw-semibold' : ''}">${falt.toLocaleString()}</td>
            `;
            body.appendChild(tr);
          });
          if (resumen) {
            const faltClass = totalFalt > 0 ? 'text-danger' : '';
            const badgeClass = totalFalt > 0 ? 'bg-danger' : 'bg-success';
            const badgeText = totalFalt > 0 ? 'Faltan' : 'OK';
            resumen.innerHTML = `
              Totales ‚Äî Requerido: <span>${totalReq.toLocaleString()}</span>
              &nbsp;|&nbsp; Stock: <span>${totalStock.toLocaleString()}</span>
              &nbsp;|&nbsp; Faltan: <span class="${faltClass}">${totalFalt.toLocaleString()}</span>
              &nbsp;<span class="badge rounded-pill ${badgeClass}">${badgeText}</span>
            `;
          }
        } catch (e) { /* noop */ }
      }

      detailBtn.addEventListener('click', async () => {
        const pid = parseInt(sel.value || '0', 10);
        const c = parseInt(qty.value || '0', 10);
        if (!pid || !c || c < 1) {
          setAlert(false, 'Seleccione un producto y una cantidad v√°lida.');
          return;
        }
        // Si el cache no corresponde, recalcular primero
        if (!lastCalc || lastCalc.pid !== pid || lastCalc.c !== c) {
          const calc = await calcular();
          if (!calc) return;
        }
        populateDetalleModal(lastCalc);
        try {
          const modalEl = document.getElementById('calcDetalleModal');
          const m = new bootstrap.Modal(modalEl);
          m.show();
        } catch (e) { /* noop */ }
      });
      addBtn.addEventListener('click', () => {
        const pid = parseInt(sel.value || '0', 10);
        const c = parseInt(qty.value || '0', 10);
        if (pid && c > 0 && typeof window.pedidoAddLine === 'function') {
          window.pedidoAddLine(pid, c);
          // Feedback y limpieza de la calculadora para evitar mensajes contradictorios
          try {
            setAlert(true, 'L√≠nea agregada al pedido.');
            // Ocultar resultados y deshabilitar bot√≥n hasta nuevo c√°lculo
            resultBox.classList.add('d-none');
            tbody.innerHTML = '';
            addBtn.disabled = true;
            // Opcional: desplazar a la tabla/alerta principal
            const mainAlert = document.getElementById('stockAlert');
            if (mainAlert) {
              // dar un tiempo a la validaci√≥n para actualizar el DOM
              setTimeout(() => { mainAlert.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 250);
            }
            // Mostrar toast amigable cerca del t√≠tulo
            const toast = document.getElementById('addToast');
            if (toast) {
              toast.textContent = 'L√≠nea agregada al pedido.';
              toast.classList.remove('d-none');
              toast.scrollIntoView({ behavior: 'smooth', block: 'start' });
              clearTimeout(window.__addToastTimer);
              window.__addToastTimer = setTimeout(() => toast.classList.add('d-none'), 2500);
            }
          } catch (e) { /* noop */ }
        }
      });

      // Estado inicial
      updateUM();
      updateUnitPrice();
    })();
  </script>
{% endblock %}
