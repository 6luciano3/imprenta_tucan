{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>{{ title }} - Vista previa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { --gray-100:#f3f4f6; --gray-300:#d1d5db; --gray-600:#4b5563; --gray-800:#1f2937; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; color: var(--gray-800); margin: 0; }
    .toolbar { position: sticky; top: 0; background: white; border-bottom: 1px solid var(--gray-300); padding: 12px 16px; display: flex; gap: 8px; align-items: center; justify-content: space-between; }
    .btn { padding: 8px 12px; border-radius: 8px; text-decoration: none; color: white; }
    .btn-print { background:#2563eb; }
    .btn-pdf { background:#dc2626; }
    .btn-back { background:#6b7280; }
    .container { max-width: 1024px; margin: 16px auto; background: white; }

    /* Controles tipo "pill" (segmentados) */
    .seg-group { display:flex; align-items:center; gap:10px; }
    .seg-label { font-size:12px; color: var(--gray-600); }
    .seg { display:inline-flex; background:#fff; border:1px solid var(--gray-300); border-radius:999px; padding:4px; gap:4px; }
    .seg-btn { display:inline-block; padding:6px 12px; border-radius:999px; color:#1f2937; text-decoration:none; border:0; background:transparent; }
    .seg-btn:hover { background: var(--gray-100); }
    .seg-btn.active { background:#2563eb; color:#fff; box-shadow: 0 1px 2px rgba(0,0,0,0.08); }

    .sheet { page-break-after: always; }
    header { display:flex; align-items:center; justify-content:space-between; padding: 16px 0; border-bottom:1px solid var(--gray-300); }
    header .title { font-size: 22px; font-weight: 700; }
    .title-center { text-align:center; font-size:22px; font-weight:700; margin-top:8px; }
    header .meta { font-size: 12px; color: var(--gray-600); }

    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    thead th { background: var(--gray-100); text-align: left; border-bottom: 1px solid var(--gray-300); padding: 8px; }
    tbody td { border-bottom: 1px solid var(--gray-300); padding: 8px; }
    tr:nth-child(even) td { background: #fafafa; }

    .footer { position: fixed; bottom: 0; left: 0; right: 0; height: 44px; display: flex; flex-direction: column; justify-content: center; gap: 2px; color: var(--gray-600); font-size: 12px; border-top: 1px solid var(--gray-300); padding: 4px 16px; }
    .footer-top { display:flex; align-items:center; justify-content: space-between; }
    .footer-bottom { text-align: center; }
    .page-number:after { content: "Página " counter(page) " de " counter(pages); }

    @media print {
      .no-print { display: none !important; }
      /* Márgenes "Moderados"; en apaisada, reducir margen inferior */
      @page {
        size: {{ paper|default:"A4" }} {{ orientation|default:"portrait" }};
        {% if orientation == 'landscape' %}
        /* top right bottom left */
        margin: 25mm 19mm 15mm 19mm;
        {% else %}
        margin: 25mm 19mm;
        {% endif %}
      }
      /* Texto de impresión a 9pt */
      body { font-size: 9pt; }
      table thead th, table tbody td, header .meta { font-size: 9pt; }
      body { margin: 0; }
      .container { margin: 0; }
    }
  </style>
</head>
<body>
  <div class="toolbar no-print">
    <div style="display:flex; align-items:center; gap:12px;">
      {% if simple_preview %}
        <strong>{{ title }}</strong>
        <div style="display:flex; align-items:center; gap:16px; margin-left:12px;">
          <div class="seg-group">
            <span class="seg-label">Orientación:</span>
            <div class="seg" role="group" aria-label="Orientación">
              <a href="#" onclick="setOrientation('portrait'); return false;" class="seg-btn {% if orientation == 'portrait' %}active{% endif %}">Vertical</a>
              <a href="#" onclick="setOrientation('landscape'); return false;" class="seg-btn {% if orientation == 'landscape' %}active{% endif %}">Apaisada</a>
            </div>
          </div>
          <div class="seg-group">
            <span class="seg-label">Tamaño:</span>
            <div class="seg" role="group" aria-label="Tamaño de papel">
              <a href="#" onclick="setPaper('A4'); return false;" class="seg-btn {% if paper == 'A4' %}active{% endif %}">A4</a>
              <a href="#" onclick="setPaper('LETTER'); return false;" class="seg-btn {% if paper == 'LETTER' %}active{% endif %}">Carta</a>
              <a href="#" onclick="setPaper('LEGAL'); return false;" class="seg-btn {% if paper == 'LEGAL' %}active{% endif %}">Legal</a>
              <a href="#" onclick="setPaper('TABLOID'); return false;" class="seg-btn {% if paper == 'TABLOID' %}active{% endif %}">Tabloide</a>
            </div>
          </div>
        </div>
      {% else %}
        <strong>{{ title }}</strong> — Vista previa
        <form method="get" style="display:flex; gap:8px; align-items:center;">
          {% if request.GET.top %}<input type="hidden" name="top" value="{{ request.GET.top }}" />{% endif %}
          <label>Tamaño
            <select name="paper">
              <option value="A4" {% if paper == 'A4' %}selected{% endif %}>A4</option>
              <option value="LETTER" {% if paper == 'LETTER' %}selected{% endif %}>Carta</option>
            </select>
          </label>
          <label>Orientación
            <select name="orientation">
              <option value="portrait" {% if orientation == 'portrait' %}selected{% endif %}>Vertical</option>
              <option value="landscape" {% if orientation == 'landscape' %}selected{% endif %}>Horizontal</option>
            </select>
          </label>
          <button type="submit" class="btn btn-back" style="border:0; cursor:pointer;">Aplicar</button>
        </form>
      {% endif %}
    </div>
    <div>
      <a href="javascript:window.print()" class="btn btn-print">Imprimir</a>
      {% if export_pdf_url %}<a href="{{ export_pdf_url }}" class="btn btn-pdf">Exportar PDF</a>{% endif %}
      <a href="javascript:history.back()" class="btn btn-back">Volver</a>
    </div>
  </div>

  <div class="container sheet">
    <header>
      <div style="display:flex; align-items:center; gap:12px;">
        {% if logo_url %}
          <img src="{{ logo_url }}" alt="Logo Tucán" style="height:56px;"/>
        {% else %}
          <div style="font-weight:700; font-size:18px;">Imprenta Tucán</div>
        {% endif %}
      </div>
      <div class="meta">Generado: {{ generated_at|date:"Y-m-d H:i" }}</div>
    </header>

    <div class="title-center">{{ title }}</div>

    <table>
      <thead>
        <tr>
          {% for h in headers %}
          <th>{{ h }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% if rows_page %}
        {% for row in rows_page %}
        <tr>
          {% for col in row %}
          <td>{{ col }}</td>
          {% endfor %}
        </tr>
        {% empty %}
        <tr>
          <td colspan="{{ headers|length }}" style="text-align:center; color:var(--gray-600); padding:16px;">No hay datos.</td>
        </tr>
        {% endfor %}
        {% else %}
        {% for row in rows %}
        <tr>
          {% for col in row %}
          <td>{{ col }}</td>
          {% endfor %}
        </tr>
        {% empty %}
        <tr>
          <td colspan="{{ headers|length }}" style="text-align:center; color:var(--gray-600); padding:16px;">No hay datos.</td>
        </tr>
        {% endfor %}
        {% endif %}
      </tbody>
    </table>
  </div>

  {% if page_obj %}
    <div class="no-print" style="padding:12px 0;">
      {% include 'layouts/pagination.html' with page_obj=page_obj %}
    </div>
  {% endif %}

  {% if not hide_footer %}
  <div class="footer">
    <div class="footer-top">
      <span>Imprenta Tucán — Generado: {{ generated_at|date:"Y-m-d H:i" }}</span>
      <span></span>
    </div>
    <div class="footer-bottom">
      <span class="page-number"></span>
    </div>
  </div>
  {% endif %}
  <script class="no-print">
    function setOrientation(val) {
      try {
        var url = new URL(window.location.href);
        url.searchParams.set('orientation', val);
        window.location.href = url.toString();
      } catch (e) {
        // Fallback para navegadores antiguos
        var sep = window.location.search ? '&' : '?';
        window.location.href = window.location.pathname + window.location.search + sep + 'orientation=' + encodeURIComponent(val);
      }
    }
    function setPaper(val) {
      try {
        var url = new URL(window.location.href);
        url.searchParams.set('paper', val);
        window.location.href = url.toString();
      } catch (e) {
        var sep = window.location.search ? '&' : '?';
        window.location.href = window.location.pathname + window.location.search + sep + 'paper=' + encodeURIComponent(val);
      }
    }
  </script>
</body>
</html>
