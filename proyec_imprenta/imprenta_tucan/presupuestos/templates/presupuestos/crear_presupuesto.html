{% extends 'base.html' %}
{% block title %}Nuevo Presupuesto{% endblock %}
{% block content %}
<div class="container mx-auto max-w-4xl py-8">
  <h1 class="text-3xl font-extrabold mb-6 text-gray-900 flex items-center gap-2">
    <span class="material-symbols-outlined text-blue-600">request_quote</span>
    Nuevo Presupuesto
  </h1>

  <!-- Resumen rápido -->
  <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6 rounded">
    <p class="text-blue-900 text-sm">
      Complete los datos para crear un nuevo presupuesto. Los campos marcados con <span class="text-red-500">*</span> son obligatorios.<br>
      Puede agregar observaciones o notas internas para el seguimiento.
    </p>
  </div>

  <form method="post" novalidate class="bg-white rounded-xl shadow p-6">
    {% csrf_token %}
    <!-- Renderizar solo el management_form del formset -->
    <div id="formset-hidden-fields" style="display:none;">
      {{ formset.management_form }}
    </div>
    <!-- Mostrar errores del formulario principal -->
    {% if form.errors %}
      <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-2 rounded mb-4">
        <strong>Errores en el formulario:</strong>
        <ul>
        {% for field, errors in form.errors.items %}
          <li><strong>{{ field }}:</strong> {{ errors|join:', ' }}</li>
        {% endfor %}
        </ul>
      </div>
    {% endif %}
    <!-- Mostrar errores del formset -->
    {% if formset.non_form_errors %}
      <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-2 rounded mb-4">
        <strong>Errores en los productos:</strong>
        <ul>
        {% for error in formset.non_form_errors %}
          <li>{{ error }}</li>
        {% endfor %}
        </ul>
      </div>
    {% endif %}
    {% for form_detalle in formset.forms %}
      {% if form_detalle.errors %}
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-2 rounded mb-2">
          <strong>Producto:</strong>
          <ul>
          {% for field, errors in form_detalle.errors.items %}
            <li><strong>{{ field }}:</strong> {{ errors|join:', ' }}</li>
          {% endfor %}
          </ul>
        </div>
      {% endif %}
    {% endfor %}
    {{ form.non_field_errors }}


    <!-- Agrupar datos del cliente en una tarjeta -->
    <div class="bg-white border rounded-lg shadow-sm p-4 mb-6">
      <h2 class="text-lg font-bold mb-3 flex items-center gap-2"><span class="material-symbols-outlined text-blue-600">person</span> Datos del Cliente</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="block font-semibold mb-1" for="{{ form.cliente.id_for_label }}">{{ form.cliente.label }} <span class="text-red-500">*</span></label>
          {{ form.cliente }}
          {% for error in form.cliente.errors %}<div class="text-red-500 text-sm">{{ error }}</div>{% endfor %}
        </div>
        <div id="razon-social-section">
          <label class="block font-semibold mb-1" for="id_razon_social">Razón Social</label>
          <select id="id_razon_social" name="razon_social" class="form-control" style="border-radius:6px;border:1px solid #e0e0e0;padding:4px;width:100%;">
            <option value="">Seleccione tipo de razón social</option>
            <option value="Sociedad Anónima (S.A.)">Sociedad Anónima (S.A.)</option>
            <option value="Sociedad de Responsabilidad Limitada (S.R.L.)">Sociedad de Responsabilidad Limitada (S.R.L.)</option>
            <option value="Sociedad por Acciones Simplificada (S.A.S.)">Sociedad por Acciones Simplificada (S.A.S.)</option>
            <option value="Sociedad Colectiva">Sociedad Colectiva</option>
            <option value="Sociedad en Comandita Simple (S.C.S.)">Sociedad en Comandita Simple (S.C.S.)</option>
            <option value="Sociedad en Comandita por Acciones (S.C.A.)">Sociedad en Comandita por Acciones (S.C.A.)</option>
            <option value="Sociedad de Capital e Industria">Sociedad de Capital e Industria</option>
            <option value="Sociedad Civil">Sociedad Civil</option>
            <option value="Sociedad de Hecho">Sociedad de Hecho</option>
            <option value="Empresa Unipersonal">Empresa Unipersonal</option>
            <option value="Cooperativa">Cooperativa</option>
            <option value="Asociación Civil">Asociación Civil</option>
            <option value="Fundación">Fundación</option>
          </select>
          {% for error in form.razon_social.errors %}<div class="text-red-500 text-sm">{{ error }}</div>{% endfor %}
        </div>
        <div>
          <label class="block font-semibold mb-1" for="{{ form.validez.id_for_label }}">{{ form.validez.label }}</label>
          {{ form.validez }}
          {% if form.validez.help_text %}<small class="text-gray-500">{{ form.validez.help_text }}</small>{% endif %}
          {% for error in form.validez.errors %}<div class="text-red-500 text-sm">{{ error }}</div>{% endfor %}
        </div>
      </div>
      <script>
      // Mostrar la razón social del cliente seleccionado
      document.addEventListener('DOMContentLoaded', function() {
        const clienteSelect = document.getElementById('{{ form.cliente.id_for_label }}');
        const razonSocialDiv = document.getElementById('razon-social-value');
        // Mapear id de cliente a razón social
        const clienteRazonSocial = {
          {% for c in form.fields.cliente.queryset %}
            '{{ c.pk }}': '{{ c.razon_social|default:"-"|escapejs }}',
          {% endfor %}
        };
        function updateRazonSocial() {
          const val = clienteSelect.value;
          razonSocialDiv.textContent = clienteRazonSocial[val] || '-';
        }
        if (clienteSelect) {
          clienteSelect.addEventListener('change', updateRazonSocial);
          updateRazonSocial();
        }
      });
      </script>
    </div>

    <!-- Agrupar datos del presupuesto en otra tarjeta -->
    <div class="bg-white border rounded-lg shadow-sm p-4 mb-6">
      <h2 class="text-lg font-bold mb-3 flex items-center gap-2"><span class="material-symbols-outlined text-amber-600">description</span> Datos del Presupuesto</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block font-semibold mb-1" for="{{ form.total.id_for_label }}">{{ form.total.label }} <span class="text-red-500">*</span></label>
          {{ form.total }}
          {% if form.total.help_text %}<small class="text-gray-500">{{ form.total.help_text }}</small>{% endif %}
          {% for error in form.total.errors %}<div class="text-red-500 text-sm">{{ error }}</div>{% endfor %}
        </div>
        <div>
          <label class="block font-semibold mb-1" for="{{ form.estado.id_for_label }}">{{ form.estado.label }}</label>
          {{ form.estado }}
          {% for error in form.estado.errors %}<div class="text-red-500 text-sm">{{ error }}</div>{% endfor %}
        </div>
      </div>
      <script>
        // Sincronizar el Total General con el campo Total
        function syncTotalGeneralToTotalField() {
          var totalGeneral = document.getElementById('total-general').textContent.replace('$','').replace(',','');
          var totalField = document.getElementById('{{ form.total.id_for_label }}');
          if (totalField) {
            totalField.value = parseFloat(totalGeneral) || 0;
          }
        }
        // Actualizar cada vez que cambie el Total General
        document.addEventListener('input', function(e) {
          if (e.target.classList.contains('cantidad-input') || e.target.classList.contains('precio-input')) {
            setTimeout(syncTotalGeneralToTotalField, 50);
          }
        });
        document.addEventListener('DOMContentLoaded', function() {
          setTimeout(syncTotalGeneralToTotalField, 100);
        });
        document.getElementById('agregar-producto').addEventListener('click', function() {
          setTimeout(syncTotalGeneralToTotalField, 100);
        });
        document.getElementById('productos-body').addEventListener('click', function(e) {
          if (e.target.classList.contains('eliminar-producto')) {
            setTimeout(syncTotalGeneralToTotalField, 100);
          }
        });
      </script>


    <div class="mb-4">
      <label class="block font-semibold mb-1" for="{{ form.observaciones.id_for_label }}">{{ form.observaciones.label }}</label>
      {{ form.observaciones }}
      {% for error in form.observaciones.errors %}<div class="text-red-500 text-sm">{{ error }}</div>{% endfor %}
    </div>

    <!-- Sección de productos del presupuesto -->
    <div class="mb-8">
      <h2 class="text-lg font-bold mb-2 flex items-center gap-2"><span class="material-symbols-outlined text-green-600">add_shopping_cart</span> Productos del presupuesto</h2>
      <div class="overflow-x-auto">
        <table id="productos-table" class="min-w-full bg-gray-50 rounded shadow text-sm">
          <thead style="background:#f5f5f5;">
            <tr>
              <th class="px-2 py-1 font-bold text-left" style="background:#f5f5f5;">Producto</th>
              <th class="px-2 py-1 font-bold text-right" style="background:#f5f5f5;">Cantidad</th>
              <th class="px-2 py-1 font-bold text-right" style="background:#f5f5f5;">Precio Unitario</th>
              <th class="px-2 py-1 font-bold text-right" style="background:#f5f5f5;">Total</th>
              <th class="px-2 py-1 font-bold text-center" style="background:#f5f5f5;">Eliminar</th>
            </tr>
          </thead>
          <tbody id="productos-body">
            <!-- Filas dinámicas -->
          </tbody>
          <tfoot>
            <tr style="background:#f5f5f5;">
              <td colspan="3" class="px-2 py-1 font-bold text-right">Total General</td>
              <td id="total-general" class="px-2 py-1 font-bold text-right">$0.00</td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>
      <button type="button" id="agregar-producto" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-2 rounded shadow">Agregar otro producto</button>
      <div class="text-xs text-gray-500 mt-2">Puede agregar más productos usando el botón "Agregar otro producto".</div>
    </div>
    <script>
      // Obtener productos del backend usando template context
      const productosBackend = [
        {% for p in formset.forms.0.fields.producto.queryset %}
          { value: '{{ p.pk }}', text: '{{ p.nombreProducto|escapejs }}' },
        {% endfor %}
      ];

      function crearFila(producto = '', cantidad = '', precio = '') {
        const tr = document.createElement('tr');
        tr.style.background = '#fff';
        tr.style.borderBottom = '1px solid #e0e0e0';
        tr.innerHTML = `
          <td class="px-2 py-1">
            <select class="producto-input" style="width:100%;border-radius:6px;border:1px solid #e0e0e0;padding:4px;">
              <option value="">Seleccione un producto</option>
              ${productosBackend.map(p => `<option value="${p.value}" ${p.value==producto?'selected':''}>${p.text}</option>`).join('')}
            </select>
          </td>
          <td class="px-2 py-1">
            <input type="number" min="1" class="cantidad-input" value="${cantidad}" style="width:80px;border-radius:6px;border:1px solid #e0e0e0;padding:4px;text-align:right;" />
          </td>
          <td class="px-2 py-1">
            <input type="number" min="0" step="0.01" class="precio-input" value="${precio}" style="width:100px;border-radius:6px;border:1px solid #e0e0e0;padding:4px;text-align:right;" />
          </td>
          <td class="px-2 py-1 text-right total-celda" style="font-weight:bold;">$0.00</td>
          <td class="px-2 py-1 text-center">
            <button type="button" class="eliminar-producto bg-red-500 hover:bg-red-600 text-white rounded px-2 py-1">Eliminar</button>
          </td>
        `;
        return tr;
      }

      function actualizarTotales() {
        let totalGeneral = 0;
        document.querySelectorAll('#productos-body tr').forEach(tr => {
          const cantidad = parseFloat(tr.querySelector('.cantidad-input').value) || 0;
          const precio = parseFloat(tr.querySelector('.precio-input').value) || 0;
          const total = cantidad * precio;
          tr.querySelector('.total-celda').textContent = `$${total.toFixed(2)}`;
          totalGeneral += total;
        });
        document.getElementById('total-general').textContent = `$${totalGeneral.toFixed(2)}`;
      }

      document.getElementById('agregar-producto').addEventListener('click', function() {
        const tbody = document.getElementById('productos-body');
        const tr = crearFila();
        tbody.appendChild(tr);
        actualizarTotales();
      });

      document.getElementById('productos-body').addEventListener('input', function(e) {
        if (e.target.classList.contains('cantidad-input') || e.target.classList.contains('precio-input')) {
          actualizarTotales();
        }
      });

      document.getElementById('productos-body').addEventListener('click', function(e) {
        if (e.target.classList.contains('eliminar-producto')) {
          e.target.closest('tr').remove();
          actualizarTotales();
        }
      });

      // Inicializar con una fila de ejemplo
      document.addEventListener('DOMContentLoaded', function() {
        const tbody = document.getElementById('productos-body');
        const tr = crearFila('Folleto A4 Color', 1000, 23.00);
        tbody.appendChild(tr);
        actualizarTotales();
      });
    </script>

    <div class="flex items-center gap-4 mt-6">
      <button type="submit" id="guardar-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-2 rounded shadow">Guardar</button>
      <a href="{% url 'presupuestos:lista' %}" class="text-blue-600 hover:underline">Cancelar</a>
    </div>
    <script>
      // Sincronizar la tabla dinámica con los campos ocultos del formset antes de enviar
      document.querySelector('form').addEventListener('submit', function(e) {
        const filas = document.querySelectorAll('#productos-body tr');
        // Actualizar TOTAL_FORMS
        const totalFormsInput = document.querySelector('input[name="form-TOTAL_FORMS"]');
        totalFormsInput.value = filas.length;
        // Limpiar campos ocultos previos
        const hiddenFieldsDiv = document.getElementById('formset-hidden-fields');
        hiddenFieldsDiv.querySelectorAll('input, select').forEach(el => {
          if (el.name !== 'form-TOTAL_FORMS' && el.name !== 'form-INITIAL_FORMS' && el.name !== 'form-MIN_NUM_FORMS' && el.name !== 'form-MAX_NUM_FORMS') {
            el.remove();
          }
        });
        // Crear los campos ocultos necesarios
        for (let idx = 0; idx < filas.length; idx++) {
          const tr = filas[idx];
          const producto = tr.querySelector('.producto-input').value;
          const cantidad = tr.querySelector('.cantidad-input').value;
          const precio = tr.querySelector('.precio-input').value;
          // Producto
          let inputProducto = document.createElement('input');
          inputProducto.type = 'hidden';
          inputProducto.name = `form-${idx}-producto`;
          inputProducto.value = producto;
          hiddenFieldsDiv.appendChild(inputProducto);
          // Cantidad
          let inputCantidad = document.createElement('input');
          inputCantidad.type = 'hidden';
          inputCantidad.name = `form-${idx}-cantidad`;
          inputCantidad.value = cantidad;
          hiddenFieldsDiv.appendChild(inputCantidad);
          // Precio unitario
          let inputPrecio = document.createElement('input');
          inputPrecio.type = 'hidden';
          inputPrecio.name = `form-${idx}-precio_unitario`;
          inputPrecio.value = precio;
          hiddenFieldsDiv.appendChild(inputPrecio);
        }
      });
    </script>
  </form>

  <!-- Sección de ayuda contextual -->
  <div class="mt-10 bg-gray-50 border-l-4 border-gray-300 p-4 rounded">
    <h2 class="font-bold mb-2 text-gray-700 text-lg flex items-center gap-2"><span class="material-symbols-outlined text-gray-500">info</span> Consejos para presupuestar</h2>
    <ul class="list-disc pl-6 text-gray-700 text-sm">
      <li>Verifique que el cliente esté correctamente seleccionado.</li>
      <li>Revise la validez del presupuesto para evitar confusiones.</li>
      <li>Agregue observaciones para aclaraciones internas o condiciones especiales.</li>
      <li>El campo "Total" debe reflejar el importe final acordado.</li>
      <li>Recuerde guardar y revisar el presupuesto antes de enviarlo al cliente.</li>
    </ul>
  </div>
</div>
{% endblock %}
